<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Ilmanlaatu</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
            body {
                margin: 0;
                padding: 0;
            }
        </style>
    </head>
    <body>
        <script type="module">
            import * as d3 from "https://cdn.skypack.dev/d3";

            const locale = await d3.json("https://cdn.jsdelivr.net/npm/d3-format@3/locale/fi-FI.json");
            d3.formatDefaultLocale(locale);

            import * as Plot from "https://cdn.skypack.dev/@observablehq/plot";

            let fields = [
                'time',
                'fmisid',
                'PM10_PT1H_avg',
            //    'PM25_PT1H_avg', 
            //    'O3_PT1H_avg',
            //    'CO_PT1H_avg',
            //    'SO2_PT1H_avg', 
            //    'NO2_PT1H_avg',
            //    'TRSC_PT1H_avg',
            ];

            // 'starttime': start_time,
            // 'endtime': end_time,

            let params = new Map([
                ['format', 'json'],
                ['groupareas', '0'],
                ['precision', 'double'],
                ['producer', 'airquality_urban'],
                ['area', 'Helsinki'],
                ['param', fields.join(',')],
                ['tz', 'UTC'],
            ]);

            let url = new URL('https://opendata.fmi.fi/timeseries');

            for (const [key, value] of params) {
                url.searchParams.append(key, value);
            }

            let parseTime = d3.timeParse('%Y%m%dT%H%M%S');

            let data = (await d3.json(url)).map(d => {
                return {
                    id: d.fmisid,
                    pm10: d.PM10_PT1H_avg,
                    time: parseTime(d.time),
                };
            });

            let graph = Plot.line(data, {
                x: 'time',
                y: 'pm10',
                stroke: 'id',
            });

            document.body.append(graph.plot({
                width: window.innerWidth,
                height: window.innerHeight,
                locale: 'fi',
                xasd: {
                    tickFormat: (d) => {
                        console.log(d);
                        return Plot.formatIsoDate(d);
                    }
                    // ticks: 'time',
                    // transform: (d) => d3.utcFormat(d),
                    // extent: d3.extent(data, d => d.time),
                }
            }));
        </script>
    </body>
</html>
